<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Liveness &amp; Readiness :: Kubernetes Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/kubernetes-tutorial/kubernetes-tutorial/live-ready.html">
    <link rel="prev" href="rolling-updates.html">
    <link rel="next" href="configmap.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <style>
    /* override master stylesheet properties for this partial here */

    .navbar-item {
      flex: unset;
    }

    .doc {
      max-width: unset;
    }


  </style>

  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/kubernetes-tutorial">Kubernetes Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
        <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/outer-loop-guide/" target="_blank">Outer Loop</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/openshift-starter-guides/" target="_blank">OpenShift Starter</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="kubernetes-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">1. Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="installation.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="installation.html#tutorial-all-local">CLI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="installation.html#install-minikube">Install Minikube</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="installation.html#start-kubernetes">Start Kubernetes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">2. Beginner</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kubectl.html">kubectl</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pod-rs-deployment.html">Pod, ReplicaSet, Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="service.html">Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="logs.html">Logs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="service-magic.html">Service Magic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="blue-green.html">Blue/Green Deployments</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Elementary</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="building-images.html">Building Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resources.html">Resources and Limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="rolling-updates.html">Rolling updates</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="live-ready.html">Liveness, Readiness &amp; Startup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configmap.html">ConfigMap</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Intermediate</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="secrets.html">Secrets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crds.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="volumes-persistentvolumes.html">Volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="taints-affinity.html">Taints &amp; Affinity</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="jobs-cronjobs.html">Jobs &amp; CronJobs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="daemonset.html">DaemonSet</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="statefulset.html">StatefulSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">5. Advanced</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ingress.html">Ingress</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore"  style="display: none;"  data-panel="explore">
  <div class="context">
    <span class="title">kubernetes-tutorial</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">kubernetes-tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">kubernetes-tutorial</a></li>
    <li>3. Elementary</li>
    <li><a href="live-ready.html">Liveness, Readiness &amp; Startup</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/kubernetes-tutorial/edit/master/documentation/modules/ROOT/pages/live-ready.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Liveness &amp; Readiness</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Make sure you are in the correct namespace:</p>
</div>
<div id="liveready-change-context-resource" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl config set-context --current --namespace=myspace</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure nothing else is deployed:</p>
</div>
<div id="no-resources-live-ready" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get all</code></pre>
</div>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>No resources found in myspace namespace.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re going to deploy our application with a Liveness and Readiness probe set.  Take a look at <code>myboot-deployment-live-ready.yml</code></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re running this from within VSCode you can use <span class="keyseq"><kbd>CTRL</kbd>+<kbd>p</kbd></span> (or <span class="keyseq"><kbd>CMD</kbd>+<kbd>p</kbd></span> on Mac OSX) to quickly open <code>myboot-deployment-live-ready.yml</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="title">myboot-deployment-live-ready.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: myboot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myboot
  template:
    metadata:
      labels:
        app: myboot
        env: dev
    spec:
      containers:
      - name: myboot
        image: quay.io/rhdevelopers/myboot:v1
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "300Mi"
            cpu: "250m" # 1/4 core
          limits:
            memory: "400Mi"
            cpu: "1000m" # 1 core
        livenessProbe:
          httpGet:
              port: 8080
              path: /alive
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 2
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now apply this deployment with the following command</p>
</div>
<div id="create-app-live-ready" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-deployment-live-ready.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Describe the deployment:</p>
</div>
<div id="live-ready-kubectl-describe-deployment" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl describe deployment myboot</code></pre>
</div>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>...
    Image:      quay.io/rhdevelopers/myboot:v1
    Port:       8080/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     1
      memory:  400Mi
    Requests:
      cpu:        250m
      memory:     300Mi
    Liveness:     http-get http://:8080/ delay=10s timeout=2s period=5s #success=1 #failure=3
    Readiness:    http-get http://:8080/health delay=10s timeout=1s period=3s #success=1 #failure=3
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deploy a Service:</p>
</div>
<div id="deploy-service-live-ready" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-service.yml</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset1_hosted"></a>Hosted</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP=$(minikube ip -p devnation)
PORT=$(kubectl get service/myboot -o jsonpath="{.spec.ports[*].nodePort}")</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_hosted">
<div class="paragraph">
<p>If using a hosted Kubernetes cluster like OpenShift then use curl and the EXTERNAL-IP address with port <code>8080</code> or get it using <code>kubectl</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP=$(kubectl get service myboot -o jsonpath="{.status.loadBalancer.ingress[0].ip}")
PORT=$(kubectl get service myboot -o jsonpath="{.spec.ports[*].port}")</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you are in AWS, you need to get the <code>hostname</code> instead of <code>ip.</code>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">IP=$(kubectl get service myboot -o jsonpath="{.status.loadBalancer.ingress[0].hostname}")</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Curl the Service:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl $IP:$PORT</code></pre>
</div>
</div>
<div class="paragraph">
<p>And run loop script:</p>
</div>
<div id="liveready-curl-loop" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">while true
do curl $IP:$PORT
sleep 0.8
done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Change the image:</p>
</div>
<div id="change-deployment-v2-live-ready" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl set image deployment/myboot myboot=quay.io/rhdevelopers/myboot:v2</code></pre>
</div>
</div>
<div class="paragraph">
<p>And notice the error free rolling update:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>Aloha from Spring Boot! 131 on myboot-845968c6ff-k4rvb
Aloha from Spring Boot! 134 on myboot-845968c6ff-9wvt9
Aloha from Spring Boot! 122 on myboot-845968c6ff-9824z
Bonjour from Spring Boot! 0 on myboot-8449d5468d-m88z4
Bonjour from Spring Boot! 1 on myboot-8449d5468d-m88z4
Aloha from Spring Boot! 135 on myboot-845968c6ff-9wvt9
Aloha from Spring Boot! 133 on myboot-845968c6ff-k4rvb
Aloha from Spring Boot! 137 on myboot-845968c6ff-9wvt9
Bonjour from Spring Boot! 3 on myboot-8449d5468d-m88z4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Look at the Endpoints to see which pods are part of the Service:</p>
</div>
<div id="get-endpoints-before" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get endpoints myboot -o json | jq '.subsets[].addresses[].ip'</code></pre>
</div>
</div>
<div class="paragraph">
<p>These are the Pod IPs that have passed their readiness probes:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>"10.129.2.40"
"10.130.2.37"
"10.130.2.38"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_readiness_probe"><a class="anchor" href="#_readiness_probe"></a>Readiness Probe</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Exec into a single Pod and change its readiness flag:</p>
</div>
<div id="misbehave-app-live-ready" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl exec -it myboot-845968c6ff-k5lcb /bin/bash</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/misbehave
exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>See that the pod is no longer Ready:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>NAME                      READY   STATUS    RESTARTS   AGE
myboot-845968c6ff-9wshg   1/1     Running   0          11m
myboot-845968c6ff-k5lcb   0/1     Running   0          12m
myboot-845968c6ff-zsgx2   1/1     Running   0          11m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now check the Endpoints:</p>
</div>
<div id="get-endpoints-after" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get endpoints myboot -o json | jq '.subsets[].addresses[].ip'</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that pod is now missing from the Service&#8217;s loadbalancer:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>"10.130.2.37"
"10.130.2.38"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which is also self-evident in the curl loop:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>Aloha from Spring Boot! 845 on myboot-845968c6ff-9wshg
Aloha from Spring Boot! 604 on myboot-845968c6ff-zsgx2
Aloha from Spring Boot! 846 on myboot-845968c6ff-9wshg</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_liveness_probe"><a class="anchor" href="#_liveness_probe"></a>Liveness Probe</h2>
<div class="sectionbody">
<div id="change-deployment-v3-live-ready" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl set image deployment/myboot myboot=quay.io/rhdevelopers/myboot:v3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let the rollout finish to completion across all 3 replicas:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>watch kubectl get pods
NAME                      READY   STATUS    RESTARTS   AGE
myboot-56659c9d69-6sglj   1/1     Running   0          2m2s
myboot-56659c9d69-mdllq   1/1     Running   0          97s
myboot-56659c9d69-zjt6q   1/1     Running   0          72s</code></pre>
</div>
</div>
<div class="paragraph">
<p>And as seen in the curl loop/poller:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>Jambo from Spring Boot! 40 on myboot-56659c9d69-mdllq
Jambo from Spring Boot! 26 on myboot-56659c9d69-zjt6q
Jambo from Spring Boot! 71 on myboot-56659c9d69-6sglj</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit the Deployment to point to the /alive URL:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re running this tutorial from within VSCode or would like to use VSCode to edit the resource targeted, make sure you set the following environment variable before issuing the <code>kubectl edit</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export KUBE_EDITOR="code -w"</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div id="change-liveness-v3-live-ready" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl edit deployment myboot</code></pre>
</div>
</div>
<div class="paragraph">
<p>And change the liveness probe:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>...
    spec:
      containers:
      - image: quay.io/rhdevelopers/myboot:v3
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /alive
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 2
        name: myboot
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save and close the editor, allowing that change to rollout:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                      READY   STATUS        RESTARTS   AGE
myboot-558b4f8678-nw762   1/1     Running       0          59s
myboot-558b4f8678-qbrgc   1/1     Running       0          81s
myboot-558b4f8678-z7f9n   1/1     Running       0          36s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now pick one of the pods, <code>exec</code> into it and shoot it:</p>
</div>
<div id="shot-v3-live-ready" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl exec -it myboot-558b4f8678-qbrgc /bin/bash</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/shot</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you will see it get restarted:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>NAME                      READY   STATUS    RESTARTS   AGE
myboot-558b4f8678-nw762   1/1     Running   0          4m7s
myboot-558b4f8678-qbrgc   1/1     Running   1          4m29s
myboot-558b4f8678-z7f9n   1/1     Running   0          3m44s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Plus, your exec will be terminated:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl exec -it myboot-558b4f8678-qbrgc /bin/bash</code></pre>
</div>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>curl localhost:8080/shot</code></pre>
</div>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>I have been shot in the head1000610000@myboot-558b4f8678-qbrgc:/app$ command terminated with exit code 137</code></pre>
</div>
</div>
<div class="paragraph">
<p>And your end-users will not see any errors:</p>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>Jambo from Spring Boot! 174 on myboot-558b4f8678-z7f9n
Jambo from Spring Boot! 11 on myboot-558b4f8678-qbrgc
Jambo from Spring Boot! 12 on myboot-558b4f8678-qbrgc
Jambo from Spring Boot! 206 on myboot-558b4f8678-nw762
Jambo from Spring Boot! 207 on myboot-558b4f8678-nw762
Jambo from Spring Boot! 175 on myboot-558b4f8678-z7f9n
Jambo from Spring Boot! 176 on myboot-558b4f8678-z7f9n</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clean_up"><a class="anchor" href="#_clean_up"></a>Clean up</h2>
<div class="sectionbody">
<div id="cleanup-live-ready" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete deployment myboot</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_startup_probe"><a class="anchor" href="#_startup_probe"></a>Startup Probe</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some applications require an additional startup time on their first initialization.</p>
</div>
<div class="paragraph">
<p>It might be tricky to fit this scenario into the liveness/readiness probes as you need to configure them for their normal behaviour to detect abnormalities during the running time and moreover covering the long start up time.</p>
</div>
<div class="paragraph">
<p>For instance, what if we had an application that might deadlock and we want to catch such issues immediately, we might have liveness and readiness probes that look like in <code>apps/kubefiles/myboot-deployment-live-ready-aggressive.yml</code></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re running this from within VSCode you can use <span class="keyseq"><kbd>CTRL</kbd>+<kbd>p</kbd></span> (or <span class="keyseq"><kbd>CMD</kbd>+<kbd>p</kbd></span> on Mac OSX) to quickly open <code>myboot-deployment-live-ready-aggressive.yml</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="title">myboot-deployment-live-ready-aggressive.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: myboot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myboot
  template:
    metadata:
      labels:
        app: myboot
        env: dev
    spec:
      containers:
      - name: myboot
        image: quay.io/rhdevelopers/myboot:v1
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "300Mi"
            cpu: "250m" # 1/4 core
          limits:
            memory: "400Mi"
            cpu: "1000m" # 1 core
        livenessProbe:
          httpGet:
              port: 8080
              path: /alive
          periodSeconds: 2
          timeoutSeconds: 2
          failureThreshold: 2
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          periodSeconds: 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then apply that deployment</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-deployment-live-ready-aggressive.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we&#8217;ll see from the pod watch, the pods are continually getting restarted, sometimes after it successfully boots up (because kubelet schedules for restart) and this is due to the startup time of SpringBoot.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl describe pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Events:
  Type     Reason     Age                 From               Message
  ----     ------     ----                ----               -------
  Normal   Scheduled  96s                 default-scheduler  Successfully assigned myspace/myboot-849ccd6948-8vrfq to devnation
  Normal   Pulled     92s                 kubelet            Successfully pulled image "quay.io/rhdevelopers/myboot:v1" in 3.295180194s
  Normal   Created    55s (x2 over 92s)   kubelet            Created container myboot
  Normal   Started    55s (x2 over 92s)   kubelet            Started container myboot
  Normal   Pulled     55s                 kubelet            Successfully pulled image "quay.io/rhdevelopers/myboot:v1" in 3.289395484s
  Warning  Unhealthy  52s (x4 over 90s)   kubelet            Liveness probe failed: Get "http://172.17.0.4:8080/alive": dial tcp 172.17.0.4:8080: connect: connection refused
  Normal   Killing    52s (x2 over 88s)   kubelet            Container myboot failed liveness probe, will be restarted
  Normal   Pulling    22s (x3 over 95s)   kubelet            Pulling image "quay.io/rhdevelopers/myboot:v1"
  Warning  Unhealthy  19s (x10 over 88s)  kubelet            Readiness probe failed: Get "http://172.17.0.4:8080/health": dial tcp 172.17.0.4:8080: connect: connection refused</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Startup probes</strong> fix this problem, as once the startup probe has succeeded, the rest of the probes take over, but until the startup probe passes, neither the liveness nor the readiness probes can run.</p>
</div>
<div class="paragraph">
<p><code>myboot-deployment-startup-live-ready.yml</code> is an example of a deployment with just such a probe</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re running this from within VSCode you can use <span class="keyseq"><kbd>CTRL</kbd>+<kbd>p</kbd></span> (or <span class="keyseq"><kbd>CMD</kbd>+<kbd>p</kbd></span> on Mac OSX) to quickly open <code>myboot-deployment-startup-live-ready.yml</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="title">myboot-deployment-startup-live-ready.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: myboot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myboot
  template:
    metadata:
      labels:
        app: myboot
        env: dev
    spec:
      containers:
      - name: myboot
        image: quay.io/rhdevelopers/myboot:v1
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "300Mi"
            cpu: "250m" # 1/4 core
          limits:
            memory: "400Mi"
            cpu: "1000m" # 1 core
        livenessProbe:
          httpGet:
              port: 8080
              path: /alive
          periodSeconds: 2
          timeoutSeconds: 2
          failureThreshold: 2
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          periodSeconds: 3
        startupProbe:
          httpGet:
            path: /alive
            port: 8080
          failureThreshold: 6
          periodSeconds: 5
          timeoutSeconds: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll see the difference is this section</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">        startupProbe:
          httpGet:
            path: /alive
            port: 8080
          failureThreshold: 6
          periodSeconds: 5
          timeoutSeconds: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then apply that deployment</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-deployment-startup-live-ready.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The startup probe waits for 30 seconds (<code>5 * 6</code>) to startup the application.  Notice, too, that the delay on the liveness and readiness checks has gone down to 0.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output bash">
<div class="content">
<pre class="highlightjs highlight"><code>NAME                      READY   STATUS    RESTARTS   AGE
myboot-579cc5cc47-2bk5p   0/1     Running   0          67s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Eventually your curl loop should show the pod running</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Aloha from Spring Boot! 18 on myboot-849ccd6948-8vrfq
Aloha from Spring Boot! 19 on myboot-849ccd6948-8vrfq
Aloha from Spring Boot! 20 on myboot-849ccd6948-8vrfq
Aloha from Spring Boot! 21 on myboot-849ccd6948-8vrfq</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s show that the liveness probe has taken over.
Now pick one of the pods, <code>exec</code> into it and shoot it:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl exec -it myboot-558b4f8678-qbrgc /bin/bash</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/shot</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you will see it get restarted.</p>
</div>
<div class="paragraph">
<p>Describe the pod to get the statistics of probes:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl describe pod myboot-579cc5cc47-2bk5p</code></pre>
</div>
</div>
<div class="listingblock console-output yaml">
<div class="content">
<pre class="highlightjs highlight"><code>Limits:
  cpu:     1
  memory:  400Mi
Requests:
  cpu:        250m
  memory:     300Mi
Liveness:     http-get http://:8080/ delay=10s timeout=2s period=5s #success=1 #failure=3
Readiness:    http-get http://:8080/health delay=10s timeout=1s period=3s #success=1 #failure=3
Startup:      http-get http://:8080/alive delay=0s timeout=1s period=5s #success=1 #failure=12
Environment:  &lt;none&gt;
Mounts:</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clean_up_2"><a class="anchor" href="#_clean_up_2"></a>Clean Up</h2>
<div class="sectionbody">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete deployment myboot
kubectl delete svc myboot</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="rolling-updates.html" class="query-params-link">Rolling updates</a></span>
  <span class="next"><a href="configmap.html" class="query-params-link">ConfigMap</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
